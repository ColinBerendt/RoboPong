<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera Stream</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; }
    video { width: 90%; border-radius: 10px; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Secure Live Camera Stream</h2>
  <video id="video" autoplay playsinline></video>
  <p id="status">Initializing camera...</p>

  <script>
    const video = document.getElementById('video');
    const status = document.getElementById('status');

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment" } 
        });
        video.srcObject = stream;
        status.innerText = "Camera active - sending frames...";

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        setInterval(async () => {
          if (!video.videoWidth) return;
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
          await fetch('/stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ frame: dataUrl })
          });
        }, 100);
      } catch (err) {
        console.error("Camera error:", err);
        status.innerText = "ERROR: Camera blocked or denied.";
      }
    }

    startCamera();
  </script>
</body>
</html>